#!/usr/bin/env python3
"""
Système de détection d'imprimantes automatique pour photovinc
"""

import subprocess
import logging
import os
from typing import Dict, List, Any, Optional, Tuple
from pathlib import Path
import json
from dataclasses import dataclass, asdict

logger = logging.getLogger(__name__)


@dataclass
class PrinterInfo:
    """Information sur une imprimante détectée"""
    name: str
    model: str
    status: str
    device_uri: str
    is_default: bool = False
    is_available: bool = True
    location: str = ""
    paper_size: str = "Postcard"
    
    def to_dict(self) -> Dict[str, Any]:
        return asdict(self)


class PrinterDetector:
    """Détecte et analyse les imprimantes disponibles"""
    
    def __init__(self):
        self.printers: Dict[str, PrinterInfo] = {}
        self.cache_file = Path.home() / ".photovinc_printers_cache.json"
        self.lpstat_path = "/usr/bin/lpstat"
        self.cups_available = self._check_cups()
    
    def _check_cups(self) -> bool:
        """Vérifie si CUPS est disponible"""
        try:
            result = subprocess.run(
                [self.lpstat_path, "-r"],
                capture_output=True,
                timeout=2
            )
            return result.returncode == 0
        except Exception as e:
            logger.error(f"CUPS non disponible: {e}")
            return False
    
    def detect_printers(self) -> Dict[str, PrinterInfo]:
        """Détecte toutes les imprimantes disponibles"""
        self.printers.clear()
        
        if not self.cups_available:
            logger.warning("CUPS indisponible")
            return {}
        
        try:
            result = subprocess.run(
                [self.lpstat_path, "-p", "-d"],
                capture_output=True,
                text=True,
                timeout=5
            )
            
            if result.returncode != 0:
                logger.warning("lpstat erreur")
                return {}
            
            lines = result.stdout.strip().split('\n')
            default_printer = None
            
            for line in lines:
                if 'system default' in line.lower():
                    parts = line.split(':')
                    if len(parts) >= 2:
                        default_printer = parts[-1].strip()
                
                elif line.startswith('printer'):
                    parts = line.split()
                    if len(parts) >= 4:
                        name = parts[1]
                        status = ' '.join(parts[3:])
                        device_uri = self._get_printer_uri(name)
                        model = self._detect_model(name)
                        
                        info = PrinterInfo(
                            name=name,
                            model=model,
                            status=status,
                            device_uri=device_uri,
                            is_default=(name == default_printer),
                            is_available='idle' in status.lower()
                        )
                        self.printers[name] = info
            
            return self.printers
            
        except Exception as e:
            logger.error(f"Erreur détection: {e}")
            return {}
    
    def _get_printer_uri(self, printer_name: str) -> str:
        """Obtient l'URI de l'imprimante"""
        try:
            result = subprocess.run(
                [self.lpstat_path, "-v", printer_name],
                capture_output=True,
                text=True,
                timeout=3
            )
            
            if result.returncode == 0:
                for line in result.stdout.split('\n'):
                    if ':' in line:
                        parts = line.split(':')
                        if len(parts) >= 2:
                            return ':'.join(parts[1:]).strip()
            
            return "unknown"
        except:
            return "unknown"
    
    def _detect_model(self, printer_name: str) -> str:
        """Détecte le modèle"""
        name_upper = printer_name.upper()
        
        if 'CP' in name_upper and '400' in name_upper:
            return 'Canon CP-400'
        elif 'SELPHY' in name_upper:
            return 'Canon SELPHY'
        elif 'EPSON' in name_upper:
            if 'R360' in name_upper:
                return 'Epson R360'
            return 'Epson Stylus'
        elif 'HP' in name_upper:
            return 'HP'
        
        return f"Imprimante ({printer_name})"
    
    def get_best_printer(self) -> Optional[PrinterInfo]:
        """Retourne la meilleure imprimante"""
        if not self.printers:
            return None
        
        for info in self.printers.values():
            if info.is_default and info.is_available:
                return info
        
        for info in self.printers.values():
            if info.is_available:
                return info
        
        return list(self.printers.values())[0]
    

    def _check_printer_connection(self, printer_info: PrinterInfo) -> bool:
        """Vérifie si l'imprimante est réellement connectée"""
        try:
            # Vérifier via lpstat -a (appareils disponibles)
            result = subprocess.run(
                ['lpstat', '-a', printer_info.name],
                capture_output=True,
                timeout=2
            )
            return result.returncode == 0
        except:
            # Si CUPS ne répond pas, supposer connectée
            return True

    def cache_printers(self):
        """Sauvegarde le cache"""
        try:
            data = {name: info.to_dict() for name, info in self.printers.items()}
            with open(self.cache_file, 'w') as f:
                json.dump(data, f, indent=2)
        except Exception as e:
            logger.error(f"Erreur cache: {e}")
    
    def load_cached_printers(self) -> Dict[str, PrinterInfo]:
        """Charge le cache"""
        try:
            if self.cache_file.exists():
                with open(self.cache_file, 'r') as f:
                    data = json.load(f)
                    self.printers = {
                        name: PrinterInfo(**info) 
                        for name, info in data.items()
                    }
                return self.printers
        except:
            pass
        return {}


class PrinterCompatibilityManager:
    """Gère la compatibilité"""
    
    PRINTER_PROFILES = {
        'Canon CP-400': {'paper_size': 'Postcard', 'dpi': 300, 'max_width': 101, 'max_height': 152},
        'Canon SELPHY': {'paper_size': 'Postcard', 'dpi': 300, 'max_width': 101, 'max_height': 152},
        'Epson Stylus': {'paper_size': 'A4', 'dpi': 360, 'max_width': 210, 'max_height': 297},
        'Epson R360': {'paper_size': 'Postcard', 'dpi': 360, 'max_width': 101, 'max_height': 152},
        'HP': {'paper_size': 'A4', 'dpi': 300, 'max_width': 210, 'max_height': 297}
    }
    
    @staticmethod
    def get_profile(model: str) -> Dict[str, Any]:
        """Obtient le profil"""
        for key, profile in PrinterCompatibilityManager.PRINTER_PROFILES.items():
            if key.lower() in model.lower():
                return profile
        return {'paper_size': 'A4', 'dpi': 300, 'max_width': 210, 'max_height': 297}


class PrinterIntegration:
    """Intègre les imprimantes"""
    
    def __init__(self, plugin_manager):
        self.manager = plugin_manager
        self.detector = PrinterDetector()
        self.compatibility = PrinterCompatibilityManager()
        self.selected_printer: Optional[PrinterInfo] = None
    
    def initialize(self) -> Tuple[bool, str]:
        """Initialise"""
        printers = self.detector.detect_printers()
        
        if not printers:
            printers = self.detector.load_cached_printers()
            if not printers:
                return False, "Aucune imprimante"
        
        self.detector.cache_printers()
        self.selected_printer = self.detector.get_best_printer()
        
        if not self.selected_printer:
            return False, "Aucune imprimante sélectionnée"
        
        self._configure_printer_plugin()
        
        return True, f"Imprimante: {self.selected_printer.name}"
    
    def _configure_printer_plugin(self):
        """Configure le plugin"""
        if not self.selected_printer:
            return
        
        profile = self.compatibility.get_profile(self.selected_printer.model)
        printer_config = self.manager.plugin_configs.get('printer')
        
        if printer_config:
            printer_config.settings.update({
                'printer_name': self.selected_printer.name,
                'printer_model': self.selected_printer.model,
                'device_uri': self.selected_printer.device_uri,
                'paper_size': profile.get('paper_size', 'Postcard'),
                'dpi': profile.get('dpi', 300)
            })
            self.manager.save_config()
    
    def get_printer_info(self) -> Dict[str, Any]:
        """Info imprimante"""
        if not self.selected_printer:
            return {}
        
        return {
            'name': self.selected_printer.name,
            'model': self.selected_printer.model,
            'status': self.selected_printer.status,
            'profile': self.compatibility.get_profile(self.selected_printer.model)
        }
    
    def get_all_printers(self) -> List[Dict[str, Any]]:
        """Liste toutes"""
        return [info.to_dict() for info in self.detector.printers.values()]


def setup_printer_detection(plugin_manager) -> Tuple[bool, str]:
    """Setup pour integration_complete.py"""
    integration = PrinterIntegration(plugin_manager)
    return integration.initialize()


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    
    detector = PrinterDetector()
    printers = detector.detect_printers()
    
    print("\n=== Détection Imprimantes ===")
    if printers:
        for name, info in printers.items():
            print(f"✓ {info.model} ({name})")
            print(f"  Status: {info.status}")
            print(f"  URI: {info.device_uri}")
            print()
    else:
        print("✗ Aucune imprimante détectée")
    
    print("\n=== Profils Compatibilité ===")
    for model in ['Canon CP-400', 'Epson', 'HP']:
        profile = PrinterCompatibilityManager.get_profile(model)
        print(f"{model}: {profile['paper_size']} @ {profile['dpi']} DPI")
